<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VYUHA | STRATEGIC CONSOLE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loadingOverlay">
        <div class="loader-content">
            <div class="brand-text-lg">VYUHA</div>
            <div class="loader-text">ESTABLISHING SECURE CONNECTION...</div>
        </div>
    </div>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="brand-text-login">VYUHA</div>
            <p class="login-subtitle">STRATEGIC CONTROL CENTER</p>
            
            <input type="email" id="loginEmail" class="login-input" placeholder="ENTER IDENTIFIER (EMAIL)" autocomplete="off">
            <input type="password" id="loginPass" class="login-input" placeholder="ENTER KEY (PASSWORD)">
            
            <button class="login-btn" id="btnLogin">AUTHENTICATE</button>
            <div id="loginMsg" class="error-text"></div>
            
            <div class="login-footer">POWERED BY IBB SYSTEM</div>
        </div>
    </div>

    <div id="dashboardWrapper" class="hidden">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="VYUHA" class="sidebar-logo" onerror="this.style.display='none'; document.getElementById('txtLogo').style.display='block'">
                <div id="txtLogo" class="sidebar-brand" style="display:none">VYUHA</div>
            </div>

            <div class="user-profile-summary">
                <div class="user-avatar-small" id="sidebarAvatar"></div>
                <div class="user-info-text">
                    <span id="sidebarName">LOADING...</span>
                    <span id="sidebarRole" class="role-badge">UNIT</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="switchTab('profile')">
                    <i class="ph-bold ph-identification-card"></i>
                    <span>IDENTITY</span>
                </div>
                <div class="nav-item" onclick="switchTab('ai')">
                    <i class="ph-bold ph-brain"></i>
                    <span>NEURAL LOGIC</span>
                </div>
                <div class="nav-item hidden" id="navAdmin" onclick="switchTab('admin')">
                    <i class="ph-bold ph-sliders-horizontal"></i>
                    <span>WAR ROOMS</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" id="btnLogout">
                    <i class="ph-bold ph-sign-out"></i> LOGOUT
                </button>
            </div>
        </aside>

        <main class="content-area">
            
            <section id="tab-profile" class="tab-content">
                <div class="section-header">
                    <h1>IDENTITY CONFIGURATION</h1>
                    <p>MANAGE CREDENTIALS AND PUBLIC APPEARANCE.</p>
                </div>

                <div id="statsPanel" class="stats-container hidden">
                    <div class="stat-card">
                        <label>CURRENT RANK</label>
                        <div id="valRank">--</div>
                    </div>
                    <div class="stat-card">
                        <label>TOTAL WINS</label>
                        <div id="valWins">0</div>
                    </div>
                    <div class="stat-card">
                        <label>MATCHES PLAYED</label>
                        <div id="valMatches">0</div>
                    </div>
                    <div class="stat-card">
                        <label>STATUS</label>
                        <div id="valStatus" class="status-active">ACTIVE</div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>UNIT NAME <span class="badge-lock">LOCKED</span></label>
                        <input type="text" id="p_name" class="input-field locked" disabled placeholder="LOADING...">
                    </div>

                    <div class="form-group">
                        <label>BOT IDENTITY <span class="badge-lock">LOCKED</span></label>
                        <input type="text" id="p_botName" class="input-field locked" disabled placeholder="LOADING...">
                    </div>

                    <div class="form-group">
                        <label>OPERATIONAL BASE (CITY)</label>
                        <input type="text" id="p_city" class="input-field" placeholder="Enter City">
                    </div>

                    <div class="form-group" id="grp_affiliation">
                        <label>AFFILIATION (SCHOOL/CLASS)</label>
                        <input type="text" id="p_link" class="input-field" placeholder="Linked School / Class">
                    </div>

                    <div class="form-group">
                        <label>SECURE EMAIL</label>
                        <input type="email" id="p_email" class="input-field locked" disabled>
                    </div>

                    <div class="form-group" id="grp_mobile">
                        <label>EMERGENCY CONTACT (MOBILE)</label>
                        <input type="text" id="p_mobile" class="input-field">
                    </div>
                </div>

                <div class="form-group" id="grp_logo">
                    <label>VISUAL IDENTIFIER (SELECT AVATAR)</label>
                    <div class="logo-grid" id="logoSelector">
                        </div>
                    <input type="hidden" id="p_logo_value">
                </div>

                <div class="form-group full-width">
                    <label>MANIFESTO / BIO</label>
                    <textarea id="p_bio" class="input-field textarea" placeholder="Define your purpose..."></textarea>
                </div>

                <div class="form-group full-width" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                    <label>ACCESS KEY (CHANGE PASSWORD)</label>
                    <input type="text" id="p_pass" class="input-field" placeholder="Enter new strong password">
                    <div id="pwStrength" class="info-text">MUST BE 8+ CHARS WITH SYMBOLS</div>
                </div>
            </section>

            <section id="tab-ai" class="tab-content hidden">
                <div class="section-header">
                    <h1>NEURAL LOGIC</h1>
                    <p>CONFIGURE API KEYS AND BATTLE STRATEGIES.</p>
                </div>

                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>GOOGLE GEMINI API KEY <span class="badge-visible">VISIBLE</span></label>
                        <input type="text" id="ai_key" class="input-field" placeholder="Paste your AI Key here...">
                    </div>
                    <div class="form-group">
                        <label>AI MODEL VERSION</label>
                        <input type="text" id="ai_model" class="input-field" value="gemini-2.5-flash">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>GLOBAL SYSTEM PROMPT (BASE BEHAVIOR)</label>
                    <textarea id="ai_global" class="input-field textarea large" placeholder="How should your bot behave globally?"></textarea>
                </div>

                <div class="section-divider">
                    <h2>ROOM SPECIFIC STRATEGIES</h2>
                    <p>Override logic for specific battlegrounds.</p>
                </div>
                
                <div id="roomPromptsContainer">
                    <div class="loading-text">LOADING BATTLEGROUNDS...</div>
                </div>
            </section>

            <section id="tab-admin" class="tab-content hidden">
                <div class="section-header">
                    <h1>WAR ROOM MANAGER</h1>
                    <p>CREATE, DESTROY, AND MANAGE BATTLEFIELDS.</p>
                </div>

                <div class="create-room-box">
                    <h3>DEPLOY NEW ROOM</h3>
                    <div class="room-form-row">
                        <input type="text" id="new_room_name" placeholder="Room Name">
                        <input type="text" id="new_room_topic" placeholder="Topic Focus">
                        <select id="new_room_diff">
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                        <button id="btnCreateRoom">DEPLOY</button>
                    </div>
                </div>

                <div class="room-list-container">
                    <label>ACTIVE WAR ROOMS</label>
                    <div id="adminRoomList">
                        </div>
                </div>
            </section>

        </main>

        <div class="action-bar">
            <div class="help-section">
                <i class="ph-bold ph-lifebuoy"></i>
                <span>SUPPORT: <a href="mailto:ibbchoudhary@gmail.com">IBBCHOUDHARY@GMAIL.COM</a></span>
            </div>
            <button id="btnSave" class="save-btn">SAVE CHANGES</button>
        </div>

    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, get, update, set, remove, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
        // !!! YAHAN APNI API KEY PASTE KARO VARNA LOGIN NAHI HOGA !!!
        apiKey: "PASTE_YOUR_API_KEY_HERE",
        authDomain: "ai-quizz-97fb9.firebaseapp.com",
        databaseURL: "https://ai-quizz-97fb9-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ai-quizz-97fb9",
        storageBucket: "ai-quizz-97fb9.firebasestorage.app",
        messagingSenderId: "572423560278",
        appId: "1:572423560278:web:c15c0e8a14b452068f2ff7"
    };

    // Initialize App
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 2. GLOBAL STATE ---
    let currentUser = null;
    let userPath = null;
    let userRole = null; 

    // --- 3. STARTUP SEQUENCE ---
    window.onload = () => {
        // Purana session check karo
        const session = sessionStorage.getItem("vyuha_session");
        if (session) {
            try {
                const data = JSON.parse(session);
                console.log("RESTORING SESSION:", data.role);
                loginSuccess(data.path, data.role, data.user);
            } catch(e) {
                console.error("Session Error", e);
                document.getElementById("loadingOverlay").classList.add("hidden");
            }
        } else {
            document.getElementById("loadingOverlay").classList.add("hidden");
        }
    };

    // --- 4. LOGIN LOGIC ---
    document.getElementById("btnLogin").addEventListener("click", async () => {
        const email = document.getElementById("loginEmail").value.trim();
        const pass = document.getElementById("loginPass").value.trim();
        const msg = document.getElementById("loginMsg");
        const btn = document.getElementById("btnLogin");

        if (!email || !pass) { 
            msg.innerText = "EMAIL & PASSWORD REQUIRED"; 
            return; 
        }

        btn.innerText = "CHECKING DATABASE...";
        msg.innerText = "";

        try {
            const dbRef = ref(db);
            let found = false;

            // A. CHECK ADMIN
            const adminSnap = await get(child(dbRef, "system_config/admin_profile"));
            if (adminSnap.exists()) {
                const admin = adminSnap.val();
                if (admin.email === email && admin.password === pass) {
                    loginSuccess("system_config/admin_profile", "ADMIN", admin);
                    return;
                }
            }

            // B. CHECK STUDENTS
            if(!found) {
                const studSnap = await get(child(dbRef, "students"));
                if (studSnap.exists()) {
                    studSnap.forEach(snap => {
                        const s = snap.val();
                        // Check inside private_info
                        if (s.private_info && s.private_info.email === email && s.private_info.password === pass) {
                            const fullData = { ...s.public_info, ...s.private_info, key: snap.key };
                            loginSuccess(`students/${snap.key}`, "STUDENT", fullData);
                            found = true;
                        }
                    });
                }
            }

            // C. CHECK SCHOOLS
            if(!found) {
                const schSnap = await get(child(dbRef, "schools"));
                if (schSnap.exists()) {
                    schSnap.forEach(snap => {
                        const s = snap.val();
                        if (s.private_info && s.private_info.email === email && s.private_info.password === pass) {
                            const fullData = { ...s.public_info, ...s.private_info, key: snap.key };
                            loginSuccess(`schools/${snap.key}`, "SCHOOL", fullData);
                            found = true;
                        }
                    });
                }
            }

            if (!found) {
                msg.innerText = "WRONG EMAIL OR PASSWORD";
                btn.innerText = "TRY AGAIN";
            }

        } catch (error) {
            console.error("LOGIN ERROR:", error);
            msg.innerText = "CONNECTION ERROR: Check Console";
            btn.innerText = "AUTHENTICATE";
        }
    });

    function loginSuccess(path, role, data) {
        currentUser = data;
        userPath = path;
        userRole = role;

        sessionStorage.setItem("vyuha_session", JSON.stringify({ path, role, user: data }));

        document.getElementById("loginOverlay").classList.add("hidden");
        document.getElementById("loadingOverlay").classList.add("hidden");
        document.getElementById("dashboardWrapper").classList.remove("hidden");
        document.getElementById("dashboardWrapper").style.display = "flex"; // Force Flex

        loadDashboard();
    }

    // --- 5. DASHBOARD LOADER ---
    function loadDashboard() {
        // Sidebar Info
        document.getElementById("sidebarName").innerText = (currentUser.name || currentUser.key || "USER").toUpperCase();
        document.getElementById("sidebarRole").innerText = userRole;
        
        // Avatar
        const avatarUrl = currentUser.avatarUrl || currentUser.logoUrl || `https://api.dicebear.com/7.x/initials/svg?seed=${currentUser.name}`;
        document.getElementById("sidebarAvatar").style.backgroundImage = `url('${avatarUrl}')`;

        // Fill Forms
        document.getElementById("p_name").value = currentUser.name || currentUser.key || "";
        document.getElementById("p_city").value = currentUser.city || "";
        document.getElementById("p_email").value = currentUser.email || "";
        document.getElementById("p_pass").value = currentUser.password || "";
        document.getElementById("p_bio").value = currentUser.bio || "";
        
        document.getElementById("ai_key").value = currentUser.apiKey || "";
        document.getElementById("ai_model").value = currentUser.model || "gemini-2.5-flash";
        document.getElementById("ai_global").value = currentUser.globalPrompt || "";

        // Role Specific Visibility
        if (userRole === "ADMIN") {
            document.getElementById("navAdmin").classList.remove("hidden");
            document.getElementById("statsPanel").classList.add("hidden");
            document.getElementById("grp_affiliation").classList.add("hidden");
            document.getElementById("grp_mobile").classList.add("hidden");
            document.getElementById("grp_logo").classList.add("hidden");
            document.getElementById("p_botName").value = "SUPREME AI JUSTICE";
            loadAdminRooms();
        } 
        else if (userRole === "STUDENT") {
            document.getElementById("statsPanel").classList.remove("hidden");
            document.getElementById("p_botName").value = currentUser.botName || "NOT_SET";
            document.getElementById("p_mobile").value = currentUser.mobile || "";
            document.getElementById("p_link").value = currentUser.linkedSchool || currentUser.className || "";
            
            // Stats
            document.getElementById("valRank").innerText = currentUser.currentRank || "N/A";
            document.getElementById("valWins").innerText = currentUser.wins || "0";
            document.getElementById("valMatches").innerText = currentUser.matches || "0";
            
            renderLogoSelector();
        }
        else if (userRole === "SCHOOL") {
            document.getElementById("statsPanel").classList.remove("hidden");
            document.getElementById("grp_affiliation").classList.add("hidden");
            document.getElementById("p_botName").value = currentUser.botName || "NOT_SET";
            document.getElementById("p_mobile").value = currentUser.mobile || "";
            
            document.getElementById("valRank").innerText = currentUser.currentRank || "N/A";
            document.getElementById("valWins").innerText = currentUser.wins || "0";
            document.getElementById("valMatches").innerText = currentUser.matches || "0";

            renderLogoSelector();
        }

        loadRoomPrompts();
    }

    // --- 6. HELPER FUNCTIONS ---
    async function loadRoomPrompts() {
        const container = document.getElementById("roomPromptsContainer");
        try {
            const snap = await get(child(ref(db), "rooms"));
            if (snap.exists()) {
                container.innerHTML = "";
                const rooms = snap.val();
                Object.keys(rooms).forEach(roomName => {
                    const room = rooms[roomName];
                    const savedPrompts = currentUser.roomPrompts || {};
                    const currentVal = savedPrompts[roomName] || "";

                    const div = document.createElement("div");
                    div.className = "form-group full-width";
                    div.style.marginTop = "15px";
                    div.innerHTML = `
                        <label>STRATEGY: ${roomName.toUpperCase()} <span style="color:#999">(${room.difficulty})</span></label>
                        <textarea class="input-field textarea room-prompt-input" data-room="${roomName}">${currentVal}</textarea>
                    `;
                    container.appendChild(div);
                });
            }
        } catch(e) { console.error(e); }
    }

    function renderLogoSelector() {
        const seeds = ['Rohan', 'Priya', 'Max', 'Zoe', 'Titan', 'Leo'];
        const container = document.getElementById("logoSelector");
        const input = document.getElementById("p_logo_value");
        input.value = currentUser.avatarUrl || currentUser.logoUrl || "";
        container.innerHTML = "";
        
        seeds.forEach(seed => {
            const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`;
            const div = document.createElement("div");
            div.className = "logo-option";
            if (input.value === url) div.classList.add("selected");
            div.innerHTML = `<img src="${url}">`;
            div.onclick = () => {
                document.querySelectorAll(".logo-option").forEach(el => el.classList.remove("selected"));
                div.classList.add("selected");
                input.value = url;
            };
            container.appendChild(div);
        });
    }

    async function loadAdminRooms() {
        const list = document.getElementById("adminRoomList");
        const snap = await get(child(ref(db), "rooms"));
        list.innerHTML = "";
        if (snap.exists()) {
            const rooms = snap.val();
            Object.keys(rooms).forEach(key => {
                const r = rooms[key];
                const div = document.createElement("div");
                div.className = "room-item";
                div.innerHTML = `
                    <div class="room-meta"><h3>${key}</h3><span>${r.difficulty} | ${r.active?"ACTIVE":"INACTIVE"}</span></div>
                    <div>
                        <button class="btn-toggle" onclick="window.toggleRoom('${key}', ${!r.active})">${r.active?"STOP":"START"}</button>
                        <button class="btn-del" onclick="window.deleteRoom('${key}')">DELETE</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
    }

    // --- 7. ACTIONS (Global Scope for HTML OnClick) ---
    window.switchTab = (tabId) => {
        document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
        document.getElementById(`tab-${tabId}`).classList.remove("hidden");
        document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
        if(tabId==='profile') document.querySelectorAll(".nav-item")[0].classList.add("active");
        if(tabId==='ai') document.querySelectorAll(".nav-item")[1].classList.add("active");
        if(tabId==='admin') document.getElementById("navAdmin").classList.add("active");
    };

    window.toggleRoom = async (name, status) => {
        await update(ref(db, `rooms/${name}`), { active: status });
        loadAdminRooms();
    };

    window.deleteRoom = async (name) => {
        if(confirm(`DELETE ${name}?`)) {
            await remove(ref(db, `rooms/${name}`));
            loadAdminRooms();
        }
    };

    document.getElementById("btnCreateRoom").onclick = async () => {
        const name = document.getElementById("new_room_name").value;
        const topic = document.getElementById("new_room_topic").value;
        const diff = document.getElementById("new_room_diff").value;
        if(name && topic) {
            await set(ref(db, `rooms/${name}`), { difficulty: diff, systemPrompt: `Focus on ${topic}`, active: true });
            document.getElementById("new_room_name").value = "";
            loadAdminRooms();
        }
    };

    document.getElementById("btnLogout").onclick = () => {
        sessionStorage.removeItem("vyuha_session");
        location.reload();
    };

    document.getElementById("btnSave").onclick = async () => {
        const btn = document.getElementById("btnSave");
        btn.innerText = "SAVING...";
        
        const updates = {};
        const path = userPath;
        
        // Private Info Updates
        updates[`${path}/private_info/password`] = document.getElementById("p_pass").value;
        updates[`${path}/private_info/apiKey`] = document.getElementById("ai_key").value;
        updates[`${path}/private_info/model`] = document.getElementById("ai_model").value;
        updates[`${path}/private_info/globalPrompt`] = document.getElementById("ai_global").value;
        updates[`${path}/private_info/mobile`] = document.getElementById("p_mobile").value;
        
        // Public Info Updates
        updates[`${path}/public_info/city`] = document.getElementById("p_city").value;
        updates[`${path}/public_info/bio`] = document.getElementById("p_bio").value;

        if(userRole === "STUDENT") {
             updates[`${path}/public_info/avatarUrl`] = document.getElementById("p_logo_value").value;
        }

        // Admin Specifics
        if(userRole === "ADMIN") {
             updates[`${path}/password`] = document.getElementById("p_pass").value;
             updates[`${path}/bio`] = document.getElementById("p_bio").value;
             updates[`${path}/city`] = document.getElementById("p_city").value;
             // Remove unnecessary paths for admin if structure differs
        }

        try {
            await update(ref(db), updates);
            btn.innerText = "SAVED!";
            btn.style.background = "#00CC66";
            setTimeout(() => { btn.innerText = "SAVE CHANGES"; btn.style.background = "#000"; }, 2000);
        } catch(e) {
            alert("Error: " + e.message);
            btn.innerText = "RETRY";
        }
    };

</script>

</body>
</html>